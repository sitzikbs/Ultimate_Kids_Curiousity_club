// Kids Curiosity Club - Bundled JavaScript (Optimized)
// Combined from navbar.js, footer.js, shows.js, podcast_links.js, podcast_icons.js, script.js

(function() {
  'use strict';

  // Google Analytics Setup
  function initGoogleAnalytics() {
    // Load gtag script
    const script = document.createElement('script');
    script.async = true;
    script.src = 'https://www.googletagmanager.com/gtag/js?id=G-6Y7PCZS0FZ';
    document.head.appendChild(script);

    // Initialize dataLayer and gtag
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-6Y7PCZS0FZ');
    
    // Make gtag globally available
    window.gtag = gtag;
  }

  // Initialize Google Analytics immediately
  initGoogleAnalytics();

  // Utility function for path detection
  function isInPagesDirectory() {
    return window.location.pathname.includes('/pages/');
  }
  
  function isInShowsDirectory() {
    return window.location.pathname.includes('/pages/shows/');
  }
  
  function getPathPrefix() {
    if (isInShowsDirectory()) return '../../';
    if (isInPagesDirectory()) return '../';
    return '';
  }

  // ------------------------- Shows data and rendering ------------------------------------
  let showsData = [];
  
  async function loadShowsData() {
    if (showsData.length === 0) {
      const pathPrefix = getPathPrefix();
      const jsonPath = pathPrefix + 'data/shows.json';
      const response = await fetch(jsonPath);
      showsData = await response.json();
    }
    return showsData;
  }

  // ------------------------- Podcast icons ------------------------------------
  window.podcastIcons = window.podcastIcons || {};

  // ------------------------- Navbar functionality ------------------------------------
  function loadNavbar() {
    const pathPrefix = getPathPrefix();
    const navPath = pathPrefix + 'pages/navbar.html';
    return fetch(navPath)
      .then(response => response.text())
      .then(data => {
        const container = document.getElementById('navbar-container');
        if (container) {
          container.innerHTML = data;
          fixNavbarPaths();
        }
      });
  }

  function fixNavbarPaths() {
    const pathPrefix = getPathPrefix();
    const logo = document.getElementById('navbar-logo');
    if (logo) {
      logo.src = pathPrefix + 'assets/logo.png';
    }

    const links = {
      'navbar-home-link': pathPrefix + 'index.html',
      'navbar-home-nav-link': pathPrefix + 'index.html',
      'navbar-shows-link': pathPrefix + 'pages/shows.html',
      'navbar-about-link': pathPrefix + 'pages/about.html', 
      'navbar-contact-link': pathPrefix + 'pages/contact.html',
      'navbar-subscribe-link': pathPrefix + 'pages/subscribe.html'
    };

    Object.entries(links).forEach(([id, href]) => {
      const element = document.getElementById(id);
      if (element) element.href = href;
    });

    // Load social media icons
    loadSocialMediaIcons();
  }

  // ------------------------- Social Media functionality ------------------------------------
  async function loadSocialMediaIcons() {
    const container = document.getElementById('navbar-social-icons');
    if (!container) return;

    try {
      const links = await loadExternalLinks();
      const socialLinks = links.social;
      const pathPrefix = getPathPrefix();
      
      const socialIcons = [
        { key: 'instagram', iconPath: `${pathPrefix}assets/social/instagram.svg`, label: 'Instagram' },
        { key: 'facebook', iconPath: `${pathPrefix}assets/social/facebook.svg`, label: 'Facebook' },
        { key: 'twitter', iconPath: `${pathPrefix}assets/social/twitter.svg`, label: 'Twitter' }
      ];

      container.innerHTML = socialIcons.map(({ key, iconPath, label }) => `
        <a href="${socialLinks[key] || '#'}" class="social-icon me-2" 
           target="_blank" rel="noopener noreferrer" 
           title="${label}" aria-label="${label}">
          <img src="${iconPath}" alt="${label}" class="social-icon-svg">
        </a>
      `).join('');
    } catch (error) {
      console.log('Could not load social media links');
    }
  }

  // ------------------------- Footer functionality ------------------------------------
  function loadFooter() {
    const pathPrefix = getPathPrefix();
    const footPath = pathPrefix + 'pages/footer.html';
    return fetch(footPath)
      .then(response => response.text())
      .then(data => {
        const container = document.getElementById('footer-container');
        if (container) {
          container.innerHTML = data;
          fixFooterPaths();
        }
      });
  }

  function fixFooterPaths() {
    const pathPrefix = getPathPrefix();
    const links = {
      'footer-privacy-link': pathPrefix + 'pages/privacy.html',
      'footer-contact-link': pathPrefix + 'pages/contact.html'
    };

    Object.entries(links).forEach(([id, href]) => {
      const element = document.getElementById(id);
      if (element) element.href = href;
    });
  }

  // ------------------------- Shows rendering ------------------------------------
  async function renderShows(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    // Load shows data from JSON
    await loadShowsData();

    const pathPrefix = getPathPrefix();
    const imagePrefix = pathPrefix;
    const linkPrefix = pathPrefix + 'pages/';

    const maxDescLength = 100;
    const html = '<div class="row justify-content-center">' +
      showsData.map((show, idx) => {
        const needsTruncate = show.description.length > maxDescLength;
        const shortDesc = needsTruncate ? show.description.slice(0, maxDescLength) + '...' : show.description;
        
        // Generate tags HTML
        const tagsHtml = show.tags ? show.tags.map(tag => 
          `<span class="badge tag-badge me-1 mb-1">${tag}</span>`
        ).join('') : '';
        
        return `
        <div class="col-md-4 mb-4">
          <a href="${linkPrefix}${show.link}" class="text-decoration-none">
            <div class="card show-card h-100 clickable-card">
              <img src="${imagePrefix}${show.image}" class="card-img-top" alt="${show.title}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${show.title}</h5>
                <div class="tags-container mb-2">
                  ${tagsHtml}
                </div>
                <p class="card-text show-desc" id="show-desc-${idx}">${shortDesc}
                  ${needsTruncate ? `<span class="read-more-link" data-idx="${idx}">Read more</span>` : ''}
                </p>
                <div class="mt-auto">
                  <span class="btn btn-primary">View Episodes</span>
                </div>
              </div>
            </div>
          </a>
        </div>
        `;
      }).join('') + '</div>';
    container.innerHTML = html;

    // Add read more event listeners
    container.querySelectorAll('.read-more-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation(); // Prevent card click
        const idx = this.getAttribute('data-idx');
        const descElem = document.getElementById('show-desc-' + idx);
        descElem.innerHTML = showsData[idx].description + ` <span class="read-less-link" data-idx="${idx}">Read less</span>`;
        descElem.querySelector('.read-less-link').addEventListener('click', function(ev) {
          ev.preventDefault();
          ev.stopPropagation(); // Prevent card click
          descElem.innerHTML = showsData[idx].description.slice(0, maxDescLength) + '... <span class="read-more-link" data-idx="' + idx + '">Read more</span>';
          descElem.querySelector('.read-more-link').addEventListener('click', arguments.callee.caller);
        });
      });
    });
  }

  // ------------------------- External Links functionality ------------------------------------
  async function loadExternalLinks() {
    const pathPrefix = getPathPrefix();
    const jsonPath = pathPrefix + 'data/external_links.json';
    const response = await fetch(jsonPath);
    return await response.json();
  }

  // Legacy function for backward compatibility
  async function loadPodcastLinks() {
    const links = await loadExternalLinks();
    return links.podcast;
  }

  function getPodcastLogoUrl(platform) {
    const pathPrefix = getPathPrefix();
    const iconUrls = {
      apple: `${pathPrefix}assets/logos/apple_podcast_logo.svg`,
      spotify: `${pathPrefix}assets/logos/spotify_logo.svg`, 
      amazon: `${pathPrefix}assets/logos/amazon_music_logo.svg`,
      youtube: `${pathPrefix}assets/logos/youtube_logo.svg`,
      overcast: `${pathPrefix}assets/logos/overcast_logo.svg`,
      rss: `${pathPrefix}assets/logos/rss_logo.svg`
    };
    return iconUrls[platform] || '';
  }

  function renderPodcastButtons(links) {
    const platforms = [
      { key: 'apple', label: 'Apple Podcasts' },
      { key: 'spotify', label: 'Spotify' },
      { key: 'amazon', label: 'Amazon Music' },
      { key: 'overcast', label: 'Overcast' },
      { key: 'rss', label: 'RSS Feed' }
    ];

    const container = document.getElementById('podcast-buttons');
    if (!container) return;

    container.innerHTML = '';
    const row = document.createElement('div');
    row.className = 'd-flex flex-wrap justify-content-center gap-4';

    platforms.forEach(({ key, label }) => {
      const col = document.createElement('div');
      col.className = 'd-flex flex-column align-items-center';

      const logoWrapper = document.createElement('div');
      Object.assign(logoWrapper.style, {
        height: '64px',
        width: '64px', 
        background: '#fff',
        borderRadius: '16px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center'
      });
      logoWrapper.className = 'mb-2';

      const logoImg = document.createElement('img');
      logoImg.src = getPodcastLogoUrl(key);
      logoImg.alt = key + ' logo';
      Object.assign(logoImg.style, {
        height: '48px',
        width: '48px',
        objectFit: 'contain'
      });

      logoWrapper.appendChild(logoImg);

      const a = document.createElement('a');
      a.href = links[key] || '#';
      a.className = 'btn btn-primary rounded-pill d-flex align-items-center gap-2 px-3';
      a.innerHTML = (window.podcastIcons[key] || '') + '<span>' + label + '</span>';
      a.target = '_blank';
      a.rel = 'noopener noreferrer';

      col.appendChild(logoWrapper);
      col.appendChild(a);
      row.appendChild(col);
    });

    container.appendChild(row);
  }

  // ------------------------- Episode functionality ------------------------------------
  let currentAudio = null;
  let episodesData = {};

  async function loadEpisodesData(showId) {
    if (!episodesData[showId]) {
      const pathPrefix = getPathPrefix();
      const jsonPath = pathPrefix + 'data/episodes/' + showId + '.json';
      try {
        const response = await fetch(jsonPath);
        episodesData[showId] = await response.json();
      } catch (error) {
        console.log('Could not load episodes for ' + showId);
        episodesData[showId] = { episodes: [] };
      }
    }
    return episodesData[showId];
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
  }

  function playAudio(audioUrl, episodeId, episodeTitle) {
    // Stop current audio if playing
    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }

    // Create new audio element
    currentAudio = new Audio(audioUrl);
    currentAudio.play().catch(err => {
      console.error('Error playing audio:', err);
      alert('Could not play audio. The episode may not be available yet.');
    });

    // Track analytics
    if (window.gtag) {
      window.gtag('event', 'play_episode', {
        'episode_id': episodeId,
        'episode_title': episodeTitle
      });
    }

    // Save progress to localStorage
    currentAudio.addEventListener('timeupdate', function() {
      localStorage.setItem('episode_' + episodeId + '_progress', currentAudio.currentTime);
    });

    // Clear progress when finished
    currentAudio.addEventListener('ended', function() {
      localStorage.removeItem('episode_' + episodeId + '_progress');
      if (window.gtag) {
        window.gtag('event', 'complete_episode', {
          'episode_id': episodeId,
          'episode_title': episodeTitle
        });
      }
    });
  }

  async function renderEpisodes(showId, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const data = await loadEpisodesData(showId);
    const episodes = data.episodes || [];

    if (episodes.length === 0) {
      // Show coming soon message
      container.innerHTML = `
        <div class="alert alert-info">
          <h5>Coming Soon!</h5>
          <p>Episodes are currently in production. Check back soon for exciting new adventures!</p>
        </div>
      `;
      return;
    }

    // Hide the coming soon alert if it exists
    const comingSoonAlert = document.querySelector('.alert-info');
    if (comingSoonAlert) {
      comingSoonAlert.style.display = 'none';
    }

    const html = episodes.map(episode => {
      const progress = localStorage.getItem('episode_' + episode.id + '_progress') || 0;
      const progressPercent = (parseFloat(progress) / episode.duration_seconds) * 100;

      return `
        <div class="card mb-3 episode-card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <img src="${episode.artwork_url}" alt="${episode.title}" class="img-fluid rounded">
              </div>
              <div class="col-md-9">
                <h4 class="card-title">${episode.title}</h4>
                <p class="text-muted mb-2">
                  <small>${formatDate(episode.publish_date)} â€¢ ${episode.duration}</small>
                </p>
                <p class="card-text">${episode.description}</p>
                ${episode.tags ? `
                  <div class="mb-2">
                    ${episode.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}
                  </div>
                ` : ''}
                <div class="d-flex gap-2 align-items-center">
                  <button class="btn btn-primary" onclick="playEpisode('${episode.audio_url}', '${episode.id}', '${episode.title.replace(/'/g, "\\'")}')">
                    <i class="bi bi-play-fill"></i> Play Episode
                  </button>
                  <button class="btn btn-outline-secondary" onclick="toggleShowNotes('${episode.id}')">
                    Show Notes
                  </button>
                </div>
                ${progressPercent > 5 ? `
                  <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%"></div>
                  </div>
                ` : ''}
                <div id="show-notes-${episode.id}" class="show-notes mt-3" style="display: none;">
                  <hr>
                  ${episode.show_notes_html}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = html;
  }

  function toggleShowNotes(episodeId) {
    const notes = document.getElementById('show-notes-' + episodeId);
    if (notes) {
      notes.style.display = notes.style.display === 'none' ? 'block' : 'none';
    }
  }

  async function playLatestEpisode() {
    // Try to find and play the latest episode from any show
    const shows = await loadShowsData();
    let latestEpisode = null;
    let latestDate = null;

    for (const show of shows) {
      const showId = show.link.split('/').pop().replace('.html', '');
      const data = await loadEpisodesData(showId);
      if (data.episodes && data.episodes.length > 0) {
        const episode = data.episodes[0]; // Assuming first is latest
        const episodeDate = new Date(episode.publish_date);
        if (!latestDate || episodeDate > latestDate) {
          latestDate = episodeDate;
          latestEpisode = episode;
        }
      }
    }

    if (latestEpisode) {
      playAudio(latestEpisode.audio_url, latestEpisode.id, latestEpisode.title);
      alert('Now playing: ' + latestEpisode.title);
    } else {
      alert('No episodes available yet. Check back soon!');
    }
  }

  // Global functions
  window.renderShows = renderShows;
  window.renderEpisodes = renderEpisodes;
  window.playEpisode = playAudio;
  window.toggleShowNotes = toggleShowNotes;
  window.playLatestEpisode = playLatestEpisode;

  // Initialize on DOM load
  document.addEventListener('DOMContentLoaded', function() {
    // Load navbar and footer
    Promise.all([loadNavbar(), loadFooter()]).then(() => {
      console.log("Kids Curiosity Club website is ready!");
    });

    // Initialize podcast buttons if on subscribe page
    if (document.getElementById('podcast-buttons')) {
      loadPodcastLinks().then(links => {
        renderPodcastButtons(links);
      });
    }

    // Hook up "Play Latest Episode" button on homepage
    const playLatestBtn = document.querySelector('a[href="#"]');
    if (playLatestBtn && playLatestBtn.textContent.includes('Play Latest')) {
      playLatestBtn.addEventListener('click', function(e) {
        e.preventDefault();
        playLatestEpisode();
      });
    }
  });

})();
